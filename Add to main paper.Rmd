---
title: "Untitled"
author: "Thomas Li"
date: "5/1/2021"
output: pdf_document
---

## Questions of Interest

### Using the Google Mobility Data

#### 1.

Are decreased trends in movement significant in preventing spread of Covid-19?

-   Response: deaths

-   Predictors: All Google Mobility trends in movement.

## Regression Analysis, Results and Interpretation

### Exploratory Analysis

#### Full Model (Base Covid + Google Mobility)

We read in and subset the Google mobility data. The data only included reports in CA and ranged from Mar 13, 2020 to Mar 14, 2021. 
We also took out 4 columns of data that were identifiers and not relevant for our data analysis. Lastly, we removed all rows with 
at least one NA and converted all data from percentages to decimals.

```{r message=FALSE, echo=FALSE}
# US mobility report
region_mobility21 <- read_csv("2021_US_Region_Mobility_Report.csv")
region_mobility20 <- read_csv("2020_US_Region_Mobility_Report.csv")
region_mobility20.21 <- merge(x = region_mobility20, y = region_mobility21, all = T)

# subset dataframe range to CA only
ca_mobility20.21 <- region_mobility20.21 %>% 
  filter(sub_region_1 == "California", date >= "2020-03-15", date <= "2021-03-14")

# remove unique identifier columns
ca_mobility.col <- ca_mobility20.21[,-c(5:8)]
View(ca_mobility.col)
# remove NA and convert to positive decimals
ca_mobility.dat <- na.omit(ca_mobility.col) %>%
  mutate(retail_and_recreation_percent_change_from_baseline = retail_and_recreation_percent_change_from_baseline/100+0.9, grocery_and_pharmacy_percent_change_from_baseline = grocery_and_pharmacy_percent_change_from_baseline/100+0.9,
         parks_percent_change_from_baseline = 
           parks_percent_change_from_baseline/100+0.9,
         transit_stations_percent_change_from_baseline =
           transit_stations_percent_change_from_baseline/100+0.9,
         workplaces_percent_change_from_baseline = 
           workplaces_percent_change_from_baseline/100+0.9,
         residential_percent_change_from_baseline = 
           residential_percent_change_from_baseline/100+0.9)
head(ca_mobility.dat)
```

Merged base Covid data and Google mobility data to one dataframe.

```{r echo=FALSE}
cacovid_mobility <- merge(x = ca_mobility.dat, y = fbase_data, all = T)
```

We ran an initial fitted linear model of Google mobility and 
Covid 19 data. We removed all constant data as well as singularities. 
Removed variables include:
Longitude, Latitude, Population, finternal_movement_restrictions2, finformation_campaigns2

```{r echo=FALSE}
# full fitted model
google.full1 <- lm(deaths ~ retail_and_recreation_percent_change_from_baseline + grocery_and_pharmacy_percent_change_from_baseline + parks_percent_change_from_baseline + transit_stations_percent_change_from_baseline + workplaces_percent_change_from_baseline + residential_percent_change_from_baseline + date + confirmed + tests + latitude  + longitude + population +  fschool_closing + fworkplace_closing + fgatherings_restrictions + fstay_home_restrictions + finternal_movement_restrictions  + finformation_campaigns + ftesting_policy + fcontact_tracing + stringency_index, data = cacovid_mobility)

# full fitted model w/ removed variables
google.full <- lm(deaths ~ retail_and_recreation_percent_change_from_baseline + grocery_and_pharmacy_percent_change_from_baseline + parks_percent_change_from_baseline + transit_stations_percent_change_from_baseline + workplaces_percent_change_from_baseline + residential_percent_change_from_baseline + date + confirmed + tests + fschool_closing +
            fworkplace_closing + fgatherings_restrictions + fstay_home_restrictions + ftesting_policy + fcontact_tracing + stringency_index, data = cacovid_mobility)

# summary of both fitted models
summary(google.full1)
summary(google.full)

# diagnostic plot fo full model w/ removed variables
plot(google.full, which = c(1,2))
```


We merged the Google mobility data with the Base Covid data

#### Google Mobility



## Conclusions (200 words) - Thomas

A linear regression model using only variables from base data set did not meet the required assumptions of normality.
A linear regression model using variables from base data and Google mobility data did not meet the required assumptions of normality.  
A linear regression model using only Google mobility data came closest to 
meeting assumptions of normality. We come to the conclusion that The base data does not
provide any indication that the policy measures lower the spread of Covid-19. 
Only when we build a linear model using the Google mobility, does the model provide
insight into the effects of the data on the spread of Covid-19.

### Appendix 2 (optional): Exploratory analysis not used in final paper

#### Covid19 Restriction and Google Mobility Merged Data

Running variable selection with AIC and BIC as the criteria.

```{r}
# null model
google.red <- lm(deaths ~ 1, data = cacovid_mobility)
```

AIC selected model:13 predictors
-retail_and_recreation_percent_change_from_baseline
-grocery_and_pharmacy_percent_change_from_baseline
-transit_stations_percent_change_from_baseline
-residential_percent_change_from_baseline
-confirmed
-fschool_closing
-fworkplace_closing
-fgatherings_restrictions
-fstay_home_restrictions 
-finternal_movement_restrictions
-ftesting_policy
-fcontact_tracing  
-stringency_index

```{r}
# variable selection with AIC
step(google.full, scope = list(lower = google.red, upper = google.full), trace = 0)

var_selectAIC <- lm(deaths ~ retail_and_recreation_percent_change_from_baseline  
+grocery_and_pharmacy_percent_change_from_baseline 
+transit_stations_percent_change_from_baseline  
+residential_percent_change_from_baseline 
+confirmed 
+fschool_closing  
+fworkplace_closing 
+fgatherings_restrictions 
+fstay_home_restrictions 
+finternal_movement_restrictions 
+ftesting_policy 
+fcontact_tracing
+stringency_index, data = cacovid_mobility)

summary(var_selectAIC)

# diagnostic plots for AIC selection
plot(var_selectAIC, which = c(1,2))
```

BIC selected model:12 predictors
-retail_and_recreation_percent_change_from_baseline  
-grocery_and_pharmacy_percent_change_from_baseline 
-transit_stations_percent_change_from_baseline  
-residential_percent_change_from_baseline 
-confirmed 
-fschool_closing  
-fworkplace_closing 
-fgatherings_restrictions 
-fstay_home_restrictions 
-finternal_movement_restrictions 
-ftesting_policy 
-fcontact_tracing

```{r}
# variable selection with BIC
n <- length(cacovid_mobility$deaths)
step(google.full, scope = list(lower = google.red, upper = google.full), trace = 0, k = log(n))

var_selectBIC <- lm(deaths ~ retail_and_recreation_percent_change_from_baseline  
+grocery_and_pharmacy_percent_change_from_baseline 
+transit_stations_percent_change_from_baseline  
+residential_percent_change_from_baseline 
+confirmed 
+fschool_closing  
+fworkplace_closing 
+fgatherings_restrictions 
+fstay_home_restrictions 
+finternal_movement_restrictions 
+ftesting_policy 
+fcontact_tracing, data = cacovid_mobility)

summary(var_selectBIC)

# diagnostic plots for BIC selection
plot(var_selectBIC, which = c(1,2))
```

Ultimately we use regsubset to choose the best model. Here we visualize the 
relationships between variables in the preferred model.

```{r}
cacovid_pairs <- cacovid_mobility %>% 
  select(deaths, date, tests, fschool_closing, fworkplace_closing, 
    fstay_home_restrictions, ftesting_policy, fcontact_tracing) 
pairs(cacovid_pairs)
```

After variable selection, we check for transformations. We visualize diagnostic
plots for all suggested transformation combinations of predictors and response.

```{r}
# square root transformation for both deaths and tests
regsubset.trans1 <- lm(sqrt(deaths) ~ date + sqrt(tests) + fschool_closing + fworkplace_closing + fstay_home_restrictions + ftesting_policy +fcontact_tracing, data = cacovid_mobility)

# square root transformation for tests
regsubset.trans2 <- lm(deaths ~ date + sqrt(tests) + fschool_closing + fworkplace_closing + fstay_home_restrictions + ftesting_policy +fcontact_tracing, data = cacovid_mobility)

# square root transformation for deaths and log transformation for tests
regsubset.trans3 <- lm(sqrt(deaths) ~ date + log(tests) + fschool_closing + fworkplace_closing + fstay_home_restrictions + ftesting_policy +fcontact_tracing, data = cacovid_mobility)

# log transformation for tests
regsubset.trans4 <- lm(deaths ~ date + log(tests) + fschool_closing + fworkplace_closing + fstay_home_restrictions + ftesting_policy +fcontact_tracing, data = cacovid_mobility)

# cube root transformation for tests
regsubset.trans7 <- lm(sqrt(deaths) ~ date + I(tests^(1/3)) + fschool_closing + fworkplace_closing + fstay_home_restrictions + ftesting_policy +fcontact_tracing, data = cacovid_mobility)

plot(regsubset.trans1, which = c(1,2))
plot(regsubset.trans2, which = c(1,2))
plot(regsubset.trans3, which = c(1,2))
plot(regsubset.trans4, which = c(1,2))
```

Seeing that the full model does not meet linear assumptions, we move to a model 
that only includes Google mobility and categorical base Covid data. Here we check
the diagnostic plots and see that there is still patterning in the residuals vs. 
fitted plot. 

We run variable selection and exclude only suggested variables that are categorical.
The two models look similar.

```{r}
# linear fit with Google mobility and only categorical variables from base Covid
google.factors <- lm(deaths ~ retail_and_recreation_percent_change_from_baseline + grocery_and_pharmacy_percent_change_from_baseline + parks_percent_change_from_baseline + transit_stations_percent_change_from_baseline + workplaces_percent_change_from_baseline + residential_percent_change_from_baseline + fschool_closing + fworkplace_closing + fstay_home_restrictions + ftesting_policy +fcontact_tracing, data = cacovid_mobility)

summary(google.factors)
plot(google.factors, which = c(1,2))

summary(regsubsets(deaths ~ retail_and_recreation_percent_change_from_baseline + grocery_and_pharmacy_percent_change_from_baseline + parks_percent_change_from_baseline + transit_stations_percent_change_from_baseline + workplaces_percent_change_from_baseline + residential_percent_change_from_baseline + fschool_closing + fworkplace_closing + fstay_home_restrictions + ftesting_policy +fcontact_tracing, data = cacovid_mobility))

# linear fit excluding only categorical variables that are not significant after variable selection (All Google mobility data kept regardless of variable selection suggestions)
google.factors1 <- lm(deaths ~ retail_and_recreation_percent_change_from_baseline + grocery_and_pharmacy_percent_change_from_baseline + parks_percent_change_from_baseline + transit_stations_percent_change_from_baseline + workplaces_percent_change_from_baseline + residential_percent_change_from_baseline + fschool_closing + fworkplace_closing + ftesting_policy + fcontact_tracing, data = cacovid_mobility)

summary(google.factors1)
plot(google.factors1, which = c(1,2))
```

Seeing similar trends with the dataset that includes Google mobility and 
categorical models, We turn to a model that is exclusively Google mobility 
response variables. We compare the adjusted R-squared, cp value, and BIC value 
for each model suggested by variable selection 

```{r}
# variable selection (5 var model) - suggests to take out workplaces
google.varselect <- summary(regsubsets(deaths ~ retail_and_recreation_percent_change_from_baseline + grocery_and_pharmacy_percent_change_from_baseline + parks_percent_change_from_baseline + transit_stations_percent_change_from_baseline + workplaces_percent_change_from_baseline + residential_percent_change_from_baseline, data = cacovid_mobility))

google.varselect
google.varselect$adjr2
google.varselect$cp
google.varselect$bic
```

### Appendix 4: Data Variable Description

-   **retail_and_recreation_percent_change_from_baseline** - comparison of 
pre-Covid-19 pandemic to Covid-19 pandemic travel trends to destinations 
classified as retail and recreation

-   **grocery_and_pharmacy_percent_change_from_baseline** - comparison of 
pre-Covid-19 pandemic to Covid-19 pandemic travel trends to destinations 
classified as grocery stores and pharmacies

-   **parks_percent_change_from_baseline** - comparison of 
pre-Covid-19 pandemic to Covid-19 pandemic travel trends to destinations 
classified as outdoor parks

-   **transit_stations_percent_change_from_baseline** - comparison of 
pre-Covid-19 pandemic to Covid-19 pandemic travel trends to destinations 
classified as transit stations

-   **workplaces_percent_change_from_baseline** - comparison of 
pre-Covid-19 pandemic to Covid-19 pandemic travel trends to destinations 
classified as work places

-   **residential_percent_change_from_baseline* +** - comparison of 
pre-Covid-19 pandemic to Covid-19 pandemic travel trends to destinations 
classified as residential 