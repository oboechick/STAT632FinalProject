---
title: "STAT 632 Final Project Base Data Exploritory Analysis"
author: "Nic James"
date: "04/15/2020"
output:
  pdf_document: default
---

# Project work

Running some preliminary analysis of the COVID-19 Data Hub data.

```{r}
library(pacman)
p_load(COVID19, car, tidyverse, ggplot2, dplyr, leaps, readr)
```

# Using the help function
```{r}
help("covid19")
```

# Create df:

We started by filtering the data first by United States of America, secondly by California, and finally by date. We ended with 365 rows of data for California.

```{r}
cacovid19data <- covid19("US", level = 2) %>% 
  filter(administrative_area_level_2 == "California", date >= "2020-03-15", date <= "2021-03-14")
head(cacovid19data)
tail(cacovid19data)
```

We then looked at all of the variables to look at what variables we should use.

```{r}
names(cacovid19data)
```

## Create a new data frame

### What columns do I want for the base data set?

* "date"                               
* "tests"                              
* "confirmed"                          
* "recovered"                          
* "deaths"                             
* "hosp"                               
* "vent"                               
* "icu"                                
* "administrative_area_level_2"
* "administrative_area_level_3"
* "latitude"  
* "longitude"
* "population"
* "vaccines" 
* "school_closing"                     
* "workplace_closing"                  
* "cancel_events"                      
* "gatherings_restrictions"            
* "transport_closing"                  
* "stay_home_restrictions"             
* "internal_movement_restrictions"     
* "international_movement_restrictions"
* "information_campaigns"              
* "testing_policy"                     
* "contact_tracing"                    
* "stringency_index"

We don't have data for vaccines, recovered, hosp, vent, and icu so we will remove these variables. 

```{r}
base_data <- subset(cacovid19data, select = c("date", "confirmed", "deaths", "tests","administrative_area_level_2", "latitude"  , "longitude", "population",  "school_closing", "workplace_closing", "cancel_events", "gatherings_restrictions", "transport_closing", "stay_home_restrictions", "internal_movement_restrictions", "international_movement_restrictions", "information_campaigns", "testing_policy", "contact_tracing", "stringency_index"))

head(base_data)
```

All variables have data in every row now.

```{r}
str(base_data)
nrow(base_data)
```

Need to turn the policy measures into factors before we can run a regression model. However factors need to have 2 or more levels in order to work so we will remove cancel_events, international_movement, and transport_closing.

```{r}
base_data <- subset(cacovid19data, select = c("date", "confirmed", "deaths", "tests", "latitude"  , "longitude", "population",  "school_closing", "workplace_closing",  "gatherings_restrictions", "stay_home_restrictions", "internal_movement_restrictions", "information_campaigns", "testing_policy", "contact_tracing", "stringency_index"))

head(base_data)
```

```{r}
fschool_closing = as.factor(base_data$school_closing)
fworkplace_closing <- as.factor(base_data$workplace_closing)
fgatherings_restrictions <- as.factor(base_data$gatherings_restrictions)
fstay_home_restrictions <- as.factor(base_data$stay_home_restrictions)
finternal_movement_restrictions <- as.factor(base_data$internal_movement_restrictions)
finformation_campaigns <- as.factor(base_data$information_campaigns)
ftesting_policy <- as.factor(base_data$testing_policy)
fcontact_tracing <- as.factor(base_data$contact_tracing)
```


```{r}
attach(base_data)


fbase_data <- base_data %>% 
  mutate(fschool_closing, fworkplace_closing, fgatherings_restrictions,
         fstay_home_restrictions, finternal_movement_restrictions,
         finformation_campaigns, ftesting_policy, fcontact_tracing)

head(fbase_data)
str(fbase_data)
```


```{r}
mod.0 <- lm(deaths ~ 1, data = fbase_data)
mod.full <- lm(deaths ~ date + confirmed + tests + latitude  + longitude + population +  fschool_closing +
            fworkplace_closing + fgatherings_restrictions + fstay_home_restrictions + finternal_movement_restrictions  +
            finformation_campaigns + ftesting_policy + fcontact_tracing + stringency_index, data = fbase_data)
```

We reject the null hypothesis that there and assume that there is at least one significant predictor in this model.

```{r}
anova(mod.0, mod.full)
```

This is not very useful.

```{r}
pairs(deaths ~ date + confirmed + tests + latitude  + longitude + population +  fschool_closing +
            fworkplace_closing + fgatherings_restrictions + fstay_home_restrictions + finternal_movement_restrictions  +
            finformation_campaigns + ftesting_policy + fcontact_tracing + stringency_index, data = fbase_data)
```

We should remove population, longitude, and lattitude as they have no information.i.e. they are the same number for every row.

```{r}
summary(mod.full)
```

```{r}
mod.full1 <- lm(deaths ~ date + confirmed + tests + latitude  + longitude + population +  fschool_closing +
            fworkplace_closing + fgatherings_restrictions + fstay_home_restrictions + finternal_movement_restrictions  +
            finformation_campaigns + ftesting_policy + fcontact_tracing + stringency_index, data = fbase_data)
```


```{r}
summary(mod.full1)
```

From this we can see that confirmed, fworkplace_closing2, finformation_campaigns2, finternal_movement_restrictions2, and ftesting_policy3 are not statistically significant.

```{r}
confint(mod.full1)
```

For mod.full2 we will remove information_campaign due to singularities.

```{r}
mod.full2 <- lm(deaths ~ date + confirmed + tests + fschool_closing +
            fworkplace_closing + fgatherings_restrictions + fstay_home_restrictions + finternal_movement_restrictions  +
            ftesting_policy + fcontact_tracing + stringency_index, data = fbase_data)
```

```{r}
pairs(deaths ~ date + confirmed + tests + fschool_closing +
            fworkplace_closing + fgatherings_restrictions + fstay_home_restrictions + finternal_movement_restrictions  +
            ftesting_policy + fcontact_tracing + stringency_index)
```


```{r}
summary(mod.full2)
```
```{r}
plot(mod.full2)
```

```{r}
pt <- powerTransform(cbind(confirmed, tests, fschool_closing, 
    fworkplace_closing, fgatherings_restrictions, fstay_home_restrictions, 
    finternal_movement_restrictions, ftesting_policy, fcontact_tracing, 
    stringency_index) ~ 1, fbase_data)
summary(pt)
```

```{r}
pt2 <- powerTransform(cbind(confirmed, tests, stringency_index) ~ 1, fbase_data)
summary(pt2)
```




From this we can see that ftesting_policy3, finternal_movement_restrictions2, fworkplace_closing2, and confirmed are not significant.
```{r}
confint(mod.full2)
```

```{r}
mod.full3 <- lm(deaths ~ date + confirmed + tests + fschool_closing +
            fworkplace_closing + fgatherings_restrictions + fstay_home_restrictions   +
            ftesting_policy + fcontact_tracing + stringency_index, data = fbase_data)
```

```{r}
summary(mod.full3)
```

This is heavy tailed and the residuals have a distinct pattern. So we need to look at transforming the data.
```{r}
plot(mod.full3)
```
```{r}
shapiro.test(fbase_data$deaths)
```

Looks like confirmed , tests, and stringency_index needs a logrithmic transformation.

```{r}
pt <- powerTransform(cbind(confirmed, tests, stringency_index) ~ 1, data = fbase_data)
summary(pt)
```

```{r}
mod.full4 <- lm(deaths ~ date + log(confirmed) + log(tests) + fschool_closing +
            fworkplace_closing + fgatherings_restrictions + fstay_home_restrictions   +
            ftesting_policy + fcontact_tracing + log(stringency_index), data = fbase_data)
```

```{r}
summary(mod.full4)
```

This is better than mod.full3


```{r}
plot(mod.full4)
```





























## AIC stepwise model selection

There are 14 predictors selected out of 16 (main effects), 26 (main effects plus dummy variables) were selected for each of the 3 full models created.

The chosen variables are fstay_home_restrictions2, fgatherings_restrictions3, fgatherings_restrictions4, fschool_closing3, tests, fworkplace_closing2, f workplace_closing3, finternal_movement_restrictions1, finternal_movement_restrictions2, stringency_index, fcontact_tracing2, ftesting_policy2, ftesting_policy3, and date.


```{r}
(step_aic <- step(mod.0, scope = list(lower = mod.0, upper = mod.full4), trace = 0))
```



The BIC appears to be the same as the AIC for all three models.

```{r}
(step_bic <- step(mod.0, scope = list(lower = mod.0, upper = mod.full4), trace = 0))
```



```{r}
summary(step_aic)
```




























































```{r message=FALSE}
# region mobility report
library(readr)
region_mobility21 <- read_csv("2021_US_Region_Mobility_Report.csv")
region_mobility20 <- read_csv("2020_US_Region_Mobility_Report.csv")
region_mobility20.21 <- merge(x = region_mobility20, y = region_mobility21, all = T)
```

```{r}
# subset dataframe to CA, date range, omit NA
ca_mobility20.21 <- region_mobility20.21 %>% 
  filter(sub_region_1 == "California", date >= "2020-03-15", date <= "2021-03-15")
ca_mobility.col <- ca_mobility20.21[,-c(5:8)]
ca_mobility.dat <- na.omit(ca_mobility.col)
```

```{r}
# merge base_data and ca google mobility data
cacovid_mobility <- merge(x = ca_mobility.dat, y = base_data, all = T)
View(cacovid_mobility)
```































