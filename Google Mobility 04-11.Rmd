---
title: "Google Mobility 04-11"
author: "Thomas Li"
date: "4/11/2021"
output: pdf_document
---
```{r}
library(pacman)
p_load(readr,COVID19,leaps,ggplot2,tidyverse,dplyr,car)
```


```{r message=FALSE}
# region mobility report
region_mobility21 <- read_csv("2021_US_Region_Mobility_Report.csv")
region_mobility20 <- read_csv("2020_US_Region_Mobility_Report.csv")
region_mobility20.21 <- merge(x = region_mobility20, y = region_mobility21, all = T)
```

Subsetting Google Mobility data to for linear regression model
```{r}
# subset dataframe range to CA only
ca_mobility20.21 <- region_mobility20.21 %>% 
  filter(sub_region_1 == "California", date >= "2020-03-15", date <= "2021-03-15")

# remove unique identifier columns
ca_mobility.col <- ca_mobility20.21[,-c(5:8)]

# remove NA and convert to positive decimals
ca_mobility.dat <- na.omit(ca_mobility.col) %>%
  mutate(retail_and_recreation_percent_change_from_baseline = retail_and_recreation_percent_change_from_baseline/100+0.9, grocery_and_pharmacy_percent_change_from_baseline = grocery_and_pharmacy_percent_change_from_baseline/100+0.9,
         parks_percent_change_from_baseline = 
           parks_percent_change_from_baseline/100+0.9,
         transit_stations_percent_change_from_baseline =
           transit_stations_percent_change_from_baseline/100+0.9,
         workplaces_percent_change_from_baseline = 
           workplaces_percent_change_from_baseline/100+0.9,
         residential_percent_change_from_baseline = 
           residential_percent_change_from_baseline/100+0.9)
head(ca_mobility.dat)
```


Covid-19 base data
```{r}
# covid19 data
base_data <- subset(cacovid19data, select = c("date", "confirmed", "deaths", "administrative_area_level_2", "latitude"  , "longitude", "population",  "school_closing", "workplace_closing", "gatherings_restrictions", "stay_home_restrictions", "internal_movement_restrictions", "information_campaigns", "testing_policy", "contact_tracing", "stringency_index"))
```

Factoring base data
```{r}
# covid19 data factors
fschool_closing = as.factor(base_data$school_closing)
fworkplace_closing <- as.factor(base_data$workplace_closing)
fgatherings_restrictions <- as.factor(base_data$gatherings_restrictions)
fstay_home_restrictions <- as.factor(base_data$stay_home_restrictions)
finternal_movement_restrictions <- as.factor(base_data$internal_movement_restrictions)
finformation_campaigns <- as.factor(base_data$information_campaigns)
ftesting_policy <- as.factor(base_data$testing_policy)
fcontact_tracing <- as.factor(base_data$contact_tracing)
```

Attaching factors to base data
```{r}
# attach factors to base covid19 data
attach(base_data)

fbase_data <- base_data %>% 
  mutate(fschool_closing, fworkplace_closing, fgatherings_restrictions,
         fstay_home_restrictions, finternal_movement_restrictions,
         finformation_campaigns, ftesting_policy, fcontact_tracing)

```

Merging covid 19 base data and google mobility data
```{r}
# merge covid19 and google mobility data
cacovid_mobility <- merge(x = ca_mobility.dat, y = fbase_data, all = T)
head(cacovid_mobility)
tail(cacovid_mobility)
```


We ran an initial fitted linear model with all non-constant Google mobility and 
Covid 19 data.
```{r}
# full fitted model
google.full <- lm(deaths ~ retail_and_recreation_percent_change_from_baseline + grocery_and_pharmacy_percent_change_from_baseline + parks_percent_change_from_baseline + transit_stations_percent_change_from_baseline + workplaces_percent_change_from_baseline + residential_percent_change_from_baseline + confirmed +  fschool_closing + fworkplace_closing + fgatherings_restrictions + fstay_home_restrictions + finternal_movement_restrictions  + finformation_campaigns + ftesting_policy + fcontact_tracing + stringency_index + latitude + longitude + population, data = cacovid_mobility)

summary(google.full)
```

Variable selection to show nine possible models
```{r}
# subset models
subset.summary <- summary(regsubsets(deaths ~ retail_and_recreation_percent_change_from_baseline + grocery_and_pharmacy_percent_change_from_baseline + parks_percent_change_from_baseline + transit_stations_percent_change_from_baseline + workplaces_percent_change_from_baseline + residential_percent_change_from_baseline + confirmed +  fschool_closing + fworkplace_closing + fgatherings_restrictions + fstay_home_restrictions + finternal_movement_restrictions  + finformation_campaigns + ftesting_policy + fcontact_tracing + stringency_index + latitude + longitude + population, data = cacovid_mobility))

subset.summary
```

```{r}
# null model
google.red <- lm(deaths ~ 1, data = cacovid_mobility)
```

AIC selected model:13 predictors
-retail_and_recreation_percent_change_from_baseline
-grocery_and_pharmacy_percent_change_from_baseline
-transit_stations_percent_change_from_baseline
-residential_percent_change_from_baseline
-confirmed
-fschool_closing
-fworkplace_closing
-fgatherings_restrictions
-fstay_home_restrictions 
-finternal_movement_restrictions
-ftesting_policy
-fcontact_tracing  
-stringency_index

BIC selected model:12 predictors
-retail_and_recreation_percent_change_from_baseline  
-grocery_and_pharmacy_percent_change_from_baseline 
-transit_stations_percent_change_from_baseline  
-residential_percent_change_from_baseline 
-confirmed 
-fschool_closing  
-fworkplace_closing 
-fgatherings_restrictions 
-fstay_home_restrictions 
-finternal_movement_restrictions 
-ftesting_policy 
-fcontact_tracing
    
```{r}
n <- length(cacovid_mobility$deaths)
step(google.full, scope = list(lower = google.red, upper = google.full), trace = 0)
step(google.full, scope = list(lower = google.red, upper = google.full), trace = 0, k = log(n))
```


```{r}
# 
subset.summary <- summary(regsubsets(deaths ~ retail_and_recreation_percent_change_from_baseline + grocery_and_pharmacy_percent_change_from_baseline + parks_percent_change_from_baseline + transit_stations_percent_change_from_baseline + workplaces_percent_change_from_baseline + residential_percent_change_from_baseline + confirmed +  fschool_closing + fworkplace_closing + fgatherings_restrictions + fstay_home_restrictions + finternal_movement_restrictions  + finformation_campaigns + ftesting_policy + fcontact_tracing + stringency_index, data = cacovid_mobility))

subset.summary
subset.summary$adjr2
subset.summary$cp
subset.summary$bic


```

After model selection for lowest cp and BIC, and highest adjusted R-squared
```{r}
# after model selection (7 predictors)
regsubset.fit <- lm(deaths ~ confirmed + fschool_closing + fworkplace_closing + fgatherings_restrictions + fstay_home_restrictions + finternal_movement_restrictions + ftesting_policy, data = cacovid_mobility)

summary(regsubset.fit)
```
Relationships between variables in the preferred model
```{r}
cacovid_pairs <- cacovid_mobility %>% 
  select(deaths, confirmed, fschool_closing, fworkplace_closing, 
         fgatherings_restrictions, fstay_home_restrictions, 
         finternal_movement_restrictions, ftesting_policy) 
pairs(cacovid_pairs)
```


Running a residuals vs. fitted and Q-Q plot show that the initial model does not 
follow a normal distribution. 
```{r}
# diagnostic plots
plot(regsubset.fit, which = c(1,2))
```
Transformation of all non-factor and significant predictors. The confirmed 
response can either use a log transformation or no transformation. 
```{r}
pt <- powerTransform(cbind(cacovid_mobility$confirmed) ~ 1)
summary(pt)
```

No transfomration is necessary
```{r}
# optimal lambda for response from full model
boxCox(regsubset.fit)
invTranPlot(cacovid_mobility$deaths ~ cacovid_mobility$confirmed, optimal = T)
```

```{r}
regsubset.log <- lm(deaths ~ log(confirmed) + fschool_closing + fworkplace_closing + fgatherings_restrictions + fstay_home_restrictions + finternal_movement_restrictions + ftesting_policy, data = cacovid_mobility)

plot(regsubset.log, which = c(1,2))
```


```{r}
# powerTransform and invTranPlot only work for positive values
# Yeo-Johnson boxCox works with negative values
summary(powerTransform(cbind(retail_and_recreation_percent_change_from_baseline + 
    grocery_and_pharmacy_percent_change_from_baseline + parks_percent_change_from_baseline + 
    transit_stations_percent_change_from_baseline + workplaces_percent_change_from_baseline + 
    residential_percent_change_from_baseline) ~ 1, merge.dat))
invTranPlot(merge.dat$deaths ~ merge.dat$retail_and_recreation_percent_change_from_baseline, optimal = T)
```



